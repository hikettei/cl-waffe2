<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>cl-waffe2/vm - cl-waffe2 Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "cl-waffe2/vm";
        var mkdocs_page_input_path = "vm.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> cl-waffe2 Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../install/">Install</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../overview/">Tutorials</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Tips/">Tips</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../utils/">cl-waffe2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../nodes/">cl-waffe2/vm.nodes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../generic-tensor/">cl-waffe2/vm.generic-tensor</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">cl-waffe2/vm</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#function-disassemble-waffe2-ir">[function] disassemble-waffe2-ir</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#function-benchmark-accept-instructions">[function] benchmark-accept-instructions</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#inputs">Inputs</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#return">Return</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#example">Example</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#function-compile-forward-and-backward">[function] compile-forward-and-backward</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#return_1">Return</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#function-accept-instructions">[function] accept-instructions</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../base-impl/">[Functions] cl-waffe2/base-impl</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../base-impl-nodes/">[Nodes] cl-waffe2/base-impl</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../distributions/">cl-waffe2/distributions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../nn/">cl-waffe2/nn</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../optimizer/">cl-waffe2/optimizers</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../lisp-tensor-backend/">cl-waffe2/backends.lisp</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cpu-tensor-backend/">cl-waffe2/backends.cpu</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cpu-jit-tensor-backend/">cl-waffe2/backends.jit.cpu</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">cl-waffe2 Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>cl-waffe2/vm</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="cl-waffe2-vm">cl-waffe2 VM</h1>
<h2 id="function-disassemble-waffe2-ir">[function] disassemble-waffe2-ir</h2>
<pre><code class="language-lisp">(disassemble-waffe2-ir toplevel &amp;key (backward t) (stream t) (fuse-p t))
</code></pre>
<p>Prints out the compiled cl-waffe2 IR from toplevel to each leaf points to <code>stream</code>. If <code>backward</code> was set to t, <code>backward</code> is also displayed.</p>
<h2 id="function-benchmark-accept-instructions">[function] benchmark-accept-instructions</h2>
<pre><code class="language-lisp">(benchmark-accept-instructions iseq &amp;key (n-sample 1) (ignore-first-call nil) (stream t) (top-k 10))
</code></pre>
<p>Basically, the function <code>benchmark-accept-instruction</code> executes the given list of instructions with profiling execution time, but at the end of proess, displays the report into <code>stream</code>.</p>
<h2 id="inputs">Inputs</h2>
<p><code>n-sample[fixnum]</code> repeats the iseq execution for <code>n-sample</code> times</p>
<p><code>ignore-first-call[boolean]</code> If t, ignores the first call to avoid including allocating time.</p>
<p><code>stream[stream]</code> the place to display the result</p>
<p><code>top-k[fixnum]</code> top-k slowest nodes are displayed at the end of report.</p>
<h2 id="return">Return</h2>
<p><code>result[AbstractTensor]</code></p>
<h2 id="example">Example</h2>
<pre><code class="language-lisp">CL-WAFFE2-REPL&gt; (with-no-grad (benchmark-accept-instructions (compile-forward-and-backward (!softmax (randn `(128 128)))) :n-sample 1000))
 Time(s)   |   Instruction ( * - Beyonds the average execution time)
0.005366   | &lt;WfInst[Compiled: MOVETENSORNODE-CPUTENSOR]          : TID1078760 &lt;= op(TID1078760(128 128) TID1078676(128 128))&gt;
5.62e-4    | &lt;WfInst[Compiled: VIEWTENSORNODE-T]                  : TID1078719 &lt;= op(TID1078719(128 128) TID1078717(128 1))&gt;
0.001171   | &lt;WfInst[Compiled: SCALARMUL-CPUTENSOR]               : TID1078679 &lt;= op(TID1078679(128 1) TID1078681(1))&gt;
3.62e-4    | &lt;WfInst[Compiled: VIEWTENSORNODE-T]                  : TID1078690 &lt;= op(TID1078690(128 128) TID1078679(128 1))&gt;
0.084953*  | &lt;WfInst[Compiled: ADDNODE-CPUTENSOR]                 : TID1078690 &lt;= op(TID1078690(128 128) TID1078676(128 128))&gt;
0.053719*  | &lt;WfInst[Compiled: MOVETENSORNODE-CPUTENSOR]          : TID1078719 &lt;= op(TID1078719(128 128) TID1078690(128 128))&gt;
6.69e-4    | &lt;WfInst[Compiled: MOVESCALARTENSORNODE-SCALARTENSOR] : TID1078742 &lt;= op(TID1078742(1) TID1078714(1))&gt;
0.120082*  | &lt;WfInst[Compiled: SCALARDIV-CPUTENSOR]               : TID1078719 &lt;= op(TID1078719(128 128) TID1078742(1))&gt;
0.049947*  | &lt;WfInst[Compiled: SUBNODE-CPUTENSOR]                 : TID1078760 &lt;= op(TID1078760(128 128) TID1078719(128 128))&gt;
0.004672   | &lt;WfInst[Compiled: MOVETENSORNODE-CPUTENSOR]          : TID1078839 &lt;= op(TID1078839(128 128) TID1078760(128 128))&gt;
0.166431*  | &lt;WfInst[Compiled: EXPNODE-LISPTENSOR]                : TID1078839 &lt;= op(TID1078760(128 128) TID1078839(128 128))&gt;
0.004736   | &lt;WfInst[Compiled: &lt;DELETED&gt;]                         : TID1078856 &lt;= op(TID1078856(128 128) TID1078839(128 128))&gt;
0.001068   | &lt;WfInst[Compiled: SCALARMUL-CPUTENSOR]               : TID1078805 &lt;= op(TID1078805(128 1) TID1078807(1))&gt;
4.96e-4    | &lt;WfInst[Compiled: VIEWTENSORNODE-T]                  : TID1078816 &lt;= op(TID1078816(128 128) TID1078805(128 1))&gt;
0.004744   | &lt;WfInst[Compiled: MOVETENSORNODE-CPUTENSOR]          : TID1078788 &lt;= op(TID1078788(128 128) TID1078760(128 128))&gt;
0.165539*  | &lt;WfInst[Compiled: EXPNODE-LISPTENSOR]                : TID1078788 &lt;= op(TID1078760(128 128) TID1078788(128 128))&gt;
0.085777*  | &lt;WfInst[Compiled: ADDNODE-CPUTENSOR]                 : TID1078816 &lt;= op(TID1078816(128 128) TID1078788(128 128))&gt;
0.050755*  | &lt;WfInst[Compiled: DIVNODE-CPUTENSOR]                 : TID1078856 &lt;= op(TID1078856(128 128) TID1078816(128 128))&gt;

18 Instructions | 15 Tensors

 Total Time: 0.801049 sec

 Instruction                                         | Total time (s) | Time/Total (n-sample=1000)
&lt;WfInst[Compiled: EXPNODE-LISPTENSOR]                | 0.33196998   | 41.441906%
&lt;WfInst[Compiled: ADDNODE-CPUTENSOR]                 | 0.17073      | 21.313303%
&lt;WfInst[Compiled: SCALARDIV-CPUTENSOR]               | 0.120082     | 14.990594%
&lt;WfInst[Compiled: MOVETENSORNODE-CPUTENSOR]          | 0.068501     | 8.551412%
&lt;WfInst[Compiled: DIVNODE-CPUTENSOR]                 | 0.050755     | 6.3360667%
&lt;WfInst[Compiled: SUBNODE-CPUTENSOR]                 | 0.049947     | 6.2351995%
&lt;WfInst[Compiled: &lt;DELETED&gt;]                         | 0.004736     | 0.5912248%
&lt;WfInst[Compiled: SCALARMUL-CPUTENSOR]               | 0.002239     | 0.2795085%
&lt;WfInst[Compiled: VIEWTENSORNODE-T]                  | 0.0014199999 | 0.17726754%
&lt;WfInst[Compiled: MOVESCALARTENSORNODE-SCALARTENSOR] | 6.69e-4      | 0.08351549%
{CPUTENSOR[float] :shape (128 128) :named ChainTMP1078855 
  ((0.0017760922 0.0030971088 0.017302852  ~ 0.012318904  6.049352e-4  0.0041618845)                    
   (0.012581187  0.0030174912 0.016748475  ~ 0.007076549  0.007030908  0.0017801385)   
                 ...
   (0.0036988985 0.0061271163 0.05046869   ~ 0.009297135  0.003441493  5.820294e-4)
   (0.045387346  0.004674337  0.0018589711 ~ 0.008918608  0.0024204857 0.00761818))
  :facet :input
  :requires-grad NIL
  :backward NIL}
CL-WAFFE2-REPL&gt;
;; (The result may not be the latest)
</code></pre>
<h2 id="function-compile-forward-and-backward">[function] compile-forward-and-backward</h2>
<pre><code class="language-lisp">(compile-forward-and-backward toplevel &amp;key (need-backward t) (fuse-p t) (compile-mode :default))
</code></pre>
<p>Compiles into cl-waffe2 IR from topleve to each leaf points (detach-p=t or backward=null variables). set <code>fuse-p</code>=t to get additional optimization to the generated IR.</p>
<p>Tips: <code>disassemble-waffe2-ir</code> to display compiled Instruction Sequence.</p>
<h2 id="return_1">Return</h2>
<p><code>(values forward-iseq backward-iseq leaves[an list of AbstractTensor that appeared in the node])</code></p>
<h2 id="function-accept-instructions">[function] accept-instructions</h2>
<pre><code class="language-lisp">(accept-instructions iseq)
</code></pre>
<p>Evaluates generated cl-waffe2 IR sequence.</p>
<p><code>iseq[list]</code> an list of <code>WFInstruction</code></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../generic-tensor/" class="btn btn-neutral float-left" title="cl-waffe2/vm.generic-tensor"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../base-impl/" class="btn btn-neutral float-right" title="[Functions] cl-waffe2/base-impl">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../generic-tensor/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../base-impl/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
