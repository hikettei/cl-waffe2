<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>cl-waffe2/optimizers - cl-waffe2 Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "cl-waffe2/optimizers";
        var mkdocs_page_input_path = "optimizer.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> cl-waffe2 Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../install/">Install</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../overview/">Tutorials</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../Tips/">Tips</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../utils/">cl-waffe2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../nodes/">cl-waffe2/vm.nodes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../generic-tensor/">cl-waffe2/vm.generic-tensor</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../vm/">cl-waffe2/vm</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../base-impl/">[Functions] cl-waffe2/base-impl</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../base-impl-nodes/">[Nodes] cl-waffe2/base-impl</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../distributions/">cl-waffe2/distributions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../nn/">cl-waffe2/nn</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">cl-waffe2/optimizers</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#class-abstractoptimizer">[class] AbstractOptimizer</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#example-hooks-and-calls-the-optimizer-tied-to-the-tensor">Example: Hooks and calls the optimizer tied to the tensor.</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#tips-customized-printing">Tips: Customized Printing</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#macro-defoptimizer">[macro] defoptimizer</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#input">Input</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example">Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#optimizer-sgd">[optimizer] SGD</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#initializer">Initializer</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#description">Description</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#inputs">Inputs</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#optimizer-adam">[optimizer] ADAM</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#initializer_1">Initializer</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#description_1">Description</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#inputs_1">Inputs</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../lisp-tensor-backend/">cl-waffe2/backends.lisp</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cpu-tensor-backend/">cl-waffe2/backends.cpu</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../cpu-jit-tensor-backend/">cl-waffe2/backends.jit.cpu</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">cl-waffe2 Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>cl-waffe2/optimizers</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <link rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"
  integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs"
  crossorigin="anonymous" />

<style type="text/css">
    .katex img {
      object-fit: fill;
      padding: unset;
      display: block;
      position: absolute;
      width: 100%;
      height: inherit;
    }
</style>
<h1 id="cl-waffe2optimizers">cl-waffe2/optimizers</h1>
<h2 id="class-abstractoptimizer">[class] AbstractOptimizer</h2>
<p>AbstractTensors with <code>:requires-grad=t</code> can find their gradients with the <code>(backward (build toplevel))</code> function. AbstractOptimizer is a class which minimizes the value of <code>toplevel</code> subject to <code>(grad tensor)</code>. In cl-waffe2, we initialize one AbstractOptimizer for one AbstractTensor. Specifically, one is able to create a new AbstractOptimizer with the function <code>(name tensor &amp;rest constructor-args)</code>, for example, <code>(adam (parameter (randn</code>(3 3))) :lr 1e-3)<code>to create a new Adam Optimizer, and can be tied to the tensor like:</code>(hook-optimizer! tensor abstract-optimizer)<code>. Users can define any optimizer algorithms with the</code>defoptimizer<code>macro. Optimizing tied tensors is performed by calling a</code>(step-optimize optimizer)<code>method. The parameter to be optimized can be accessed by a</code>read-parameter` method.</p>
<h3 id="example-hooks-and-calls-the-optimizer-tied-to-the-tensor">Example: Hooks and calls the optimizer tied to the tensor.</h3>
<pre><code class="language-lisp">(let ((a (parameter (randn `(3 3)))))
    (hook-optimizer! a (Adam a))
    (call-optimizer! a))
</code></pre>
<h3 id="tips-customized-printing">Tips: Customized Printing</h3>
<p>At first, AbstractOptimizers are displayed in your terminal like:</p>
<pre><code class="language-lisp">(Adam (parameter (randn `(3 3))))
;; &lt;AbstractOptimizer: ADAM( ) -&gt; TID11256&gt;
;;                          ^ You're allowed to insert something
</code></pre>
<p>The method <code>cl-waffe2/vm.nodes:on-print-object</code> is also used to customize how AbstractOptimizer is displayed:</p>
<pre><code class="language-lisp">(defmethod cl-waffe2/vm.nodes:on-print-object ((opt Adam) stream)
  (format stream &quot;lr=~a eps=~a beta1=~a beta2=~a N=~a&quot;
      (lr-of opt)
      (eps-of opt)
      (beta1-of opt)
      (beta2-of opt)
      (adam-n opt)))
</code></pre>
<p>Do not insert <code>Newline</code> here because <code>AbstractOptimizer</code> is also displayed when printing <code>AbstractTensor</code> with hooked optimizers.</p>
<p>See also: <code>defoptimizer</code> <code>read-parameter</code> <code>step-optimize</code>.</p>
<h2 id="macro-defoptimizer">[macro] defoptimizer</h2>
<p>The macro <code>defoptimizer</code> defines a user-defined optimizer class which is a subclass of <code>AbstractOptimizer</code>. And the class is dispatched one per parameter to be optimized and the method <code>step-optimize</code> is called each time an optimizing is performed.</p>
<h3 id="input">Input</h3>
<p><code>param</code> the tensor to be optimized is given as this argument. the tensor is stored in the <code>param</code> slot automatically, being accessed by a <code>read-parameter</code> method.</p>
<h3 id="example">Example</h3>
<p>We use <code>defmodel</code> and <code>defmodel-as</code> because formulae for optimisation functions can be expressed in Composite and compiled as functions to reduce compilation time.</p>
<pre><code class="language-lisp">(defoptimizer (SGD (self param &amp;key (lr 1e-3))
           :slots ((lr :initarg :lr :reader sgd-lr))))

(defmodel (SGD-Compute-Form (self)
       :where (Param[~] Grad[~] Lr[scal] -&gt; Param[~] where scal = 1)
       :documentation &quot;Param_New &lt;- Param - Param * Grad * Lr&quot;
       :on-call-&gt; ((self param grad lr)
               (declare (ignore self))
               (A-=B param (!mul lr grad)))))

(defmodel-as (SGD-Compute-Form) :named step-sgd)

(defmethod step-optimize ((optimizer SGD))
  (let* ((lr    (make-tensor (sgd-lr optimizer)))
     (param (read-parameter optimizer))
     (grad  (grad param)))    
    (step-sgd param grad lr)))
</code></pre>
<h2 id="optimizer-sgd">[optimizer] SGD</h2>
<h3 id="initializer">Initializer</h3>
<pre><code>(SGD param &amp;KEY (LR 0.001))
</code></pre>
<h3 id="description">Description</h3>
<h3 id="inputs">Inputs</h3>
<p>Implements a simple SGD.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mi>a</mi><mi>r</mi><mi>a</mi><msub><mi>m</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub><mo>←</mo><mrow><mi>P</mi><mi>a</mi><mi>r</mi><mi>a</mi><mi>m</mi><mo>−</mo><mi>P</mi><mi>a</mi><mi>r</mi><mi>a</mi><msub><mi>m</mi><mrow><mi>g</mi><mi>r</mi><mi>a</mi><mi>d</mi></mrow></msub><mo>×</mo><mrow><mi>l</mi><mi>r</mi></mrow></mrow></mrow><annotation encoding="application/x-tex">
Param_{new}\gets{Param - Param_{grad}\times{lr}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">am</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></p>
<p><code>lr[single-float]</code> learning rate.</p>
<h2 id="optimizer-adam">[optimizer] ADAM</h2>
<h3 id="initializer_1">Initializer</h3>
<pre><code>(ADAM param &amp;KEY (LR 0.001) (EPS 1.0e-7) (BETA1 0.9) (BETA2 0.999))
</code></pre>
<h3 id="description_1">Description</h3>
<h3 id="inputs_1">Inputs</h3>
<p>Implements Adam algorithm.</p>
<p>See the <a href="https://arxiv.org/abs/1412.6980">original paper</a> for detailed algorithms.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../nn/" class="btn btn-neutral float-left" title="cl-waffe2/nn"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../lisp-tensor-backend/" class="btn btn-neutral float-right" title="cl-waffe2/backends.lisp">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../nn/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../lisp-tensor-backend/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
